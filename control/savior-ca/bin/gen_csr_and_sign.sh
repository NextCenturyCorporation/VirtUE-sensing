#!/usr/bin/env bash
curl -d '{"key": {"algo": "rsa", "size": 4096}, "hosts":["sensor-001.savior"], "names":[{"C":"US", "ST":"Virginia", "L":"Arlington", "O":"sensor-001.savior"}], "CN": "sensor-001.savior"}' http://localhost:3030/api/v1/cfssl/newkey | python -m json.tool





b'55292b4762b352e385adf6b117179bbf9d0f5604a462b982e52950a33d48b578'
keyBytes = bytearray.fromhex(b'de1069ab43f7f385d9a31b76af27e7620e9aa2ad5dccd264367422a452aba67f')
h = hmac.new(keyBytes,dump_req, hashlib.sha256 )
h = hmac.new('64653130363961623433663766333835643961333162373661663237653736323065396161326164356463636432363433363734323261343532616261363766',dump_req, hashlib.sha256 )

h.digest()
1. JSON encode CSR as below:


2. DO NOT base64 dumped json

3. use #1 above base64-ed for "request" field

4. calculate the token with the profile key (as defined in config.json) and #2 above

#### FROM HERE
csr = curl -d '{"key": {"algo": "rsa", "size": 4096}, "hosts":["sensor-001.savior"], "names":[{"C":"US", "ST":"Virginia", "L":"Arlington", "O":"sensor-001.savior"}], "CN": "sensor-001.savior"}' http://localhost:3030/api/v1/cfssl/newkey | python -m json.tool

dump_req = """{"hostname": "sensor-001.savior", "hosts": ["sensor-001.savior"], "certificate_request": "-----BEGIN CERTIFICATE REQUEST-----\\nMIIE4DCCAsgCAQAwbDELMAkGA1UEBhMCVVMxETAPBgNVBAgTCFZpcmdpbmlhMRIw\\nEAYDVQQHEwlBcmxpbmd0b24xGjAYBgNVBAoTEXNlbnNvci0wMDEuc2F2aW9yMRow\\nGAYDVQQDExFzZW5zb3ItMDAxLnNhdmlvcjCCAiIwDQYJKoZIhvcNAQEBBQADggIP\\nADCCAgoCggIBAMYXjTS7Rv3p2zkEWbYn7D81wmC+1r2YFtInRM+8C3ToIw4u7hq+\\nwVR0QIL5RqD0o1anzoikzeUOdYxjTSpO6ximsATvK3WA1P/S4vhqUnWYdIrulZJm\\nNv2KFXwxEawTwbn4CKW9zGQUwDvVQ8XZagWh2AioJq8SQsaAtUMZfjQes85NXEMJ\\nHx6AGSc4g934fS/nvynepuTR2QmQrAn6pfXbRTF362yr+zQtxrr8RZs91Eu/4x3w\\nXm8UGgFu8lfiWBv1WzFRmtS/zBpJmBDnYIcVrgO/K9aE3G0Uli9mEJPsXPcmhsFL\\nLtxyQ9ewhga9emJ3iGyDLj5MaYN1vXvKBOeBV0j0GdgSWxylpS5xxfhwlQ/oMmcO\\npQmLFe2csS+ku1F5+2hSIVDJIJ8W8qecgDvqLSzbVB759+ap633LvEVw7T49WUtY\\noErYTKIMFBk4r0dQFpQOH0890MGmwOnbxFmPkVKdIJcySBOPAyZj2RNJW3yFqR7E\\nrTgY4haXzyjVO/tYb2jNu4ZG42jbGbnf7uxyYIDtJlDPLxtH+qmnFy86ezhEgv9o\\nQLTQVEJ+gLt+R7d7peyIMgVzvnYc2nxU3UM78hVNznZCqFtO6zo5lKUx0A/IWlL8\\n9gX71txVN4/TMQMclebdpiSrKZRnT+tm162deP0bxNN48acGTMN0acWlAgMBAAGg\\nLzAtBgkqhkiG9w0BCQ4xIDAeMBwGA1UdEQQVMBOCEXNlbnNvci0wMDEuc2F2aW9y\\nMA0GCSqGSIb3DQEBDQUAA4ICAQCgnv0r5mnOxnFDS5i8iG93zPXio2WVOkKUBpxi\\nbeuvDHj3tERNJWn097jF7+JaXRwCBbWHs1potMG8qSieM/krqOfEzOFp0R+4gVTZ\\nwxoBErOjSYV5WaFf0hVbFzScfIbadwOYxVoJKHQyi7QqEzRZ22Na/QNyIZAAMH3Z\\nA8TC2YrCYv1zN9KRuywAoQAFBAsV8WAQ383QzJdp3TyF2hOk76wNotSxjT0tI5eK\\nuSiouUD8/Pz+flPjGOCTyRH/vf8GEqrNF9qWtukGAvFe37Vt5S+/BsVVuAX6zmnn\\ngMhVKosJqXgNEPIcGCE5beH/jI27VhT0oKHZTg3NmuE7s3RhUscfLv0c/Jc7HPIN\\nqVkBZEQWnYA9vwjtVEJG/GtczMTcIkCTHLXVhVcm3SAGdp/9uywU9cvBBdsjGazv\\n4vTSYkKKYBs5JS3f/aTWYrgDuLZKo/sxMkmK/srfB8qWnOuo/kUm10goYm28pte9\\nQkVBNzi780qBjI8YJePaF83Xb+dt81MNli6990/Gk/FPGJE59KNFqWi22VfChxF8\\nhw3ZzaZuOw/jogY2IMc6CoUMEUgdSpHIufMnhe8gJMz+C0W/P3KxsfQmzjjpykSa\\n1imCmwp6peqAYfvPsg0NcqYFjbgDKzA9rip6GQlH6jRKFmWqycz4kKZ2rrG0fsCh\\nCpqRcA==\\n-----END CERTIFICATE REQUEST-----\\n", "profile": "default", "label": "client auth", "bundle": false}"""
h = hmac.new(keyBytes,dump_req, hashlib.sha256 )
token = base64.b64encode(h.digest())
request = base64.b64encode(dump_req)
certificate_request = ?

dBJlaIkSKqY+IbWFwzeM7pVDTBc6n7If6t9Scr1SBDo=

eyJob3N0bmFtZSI6ICJzZW5zb3ItMDAxLnNhdmlvciIsICJob3N0cyI6IFsic2Vuc29yLTAwMS5zYXZpb3IiXSwgImNlcnRpZmljYXRlX3JlcXVlc3QiOiAiLS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS1cbk1JSUU0RENDQXNnQ0FRQXdiREVMTUFrR0ExVUVCaE1DVlZNeEVUQVBCZ05WQkFnVENGWnBjbWRwYm1saE1SSXdcbkVBWURWUVFIRXdsQmNteHBibWQwYjI0eEdqQVlCZ05WQkFvVEVYTmxibk52Y2kwd01ERXVjMkYyYVc5eU1Sb3dcbkdBWURWUVFERXhGelpXNXpiM0l0TURBeExuTmhkbWx2Y2pDQ0FpSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnSVBcbkFEQ0NBZ29DZ2dJQkFNWVhqVFM3UnYzcDJ6a0VXYlluN0Q4MXdtQysxcjJZRnRJblJNKzhDM1RvSXc0dTdocStcbndWUjBRSUw1UnFEMG8xYW56b2lremVVT2RZeGpUU3BPNnhpbXNBVHZLM1dBMVAvUzR2aHFVbldZZElydWxaSm1cbk52MktGWHd4RWF3VHdibjRDS1c5ekdRVXdEdlZROFhaYWdXaDJBaW9KcThTUXNhQXRVTVpmalFlczg1TlhFTUpcbkh4NkFHU2M0ZzkzNGZTL252eW5lcHVUUjJRbVFyQW42cGZYYlJURjM2MnlyK3pRdHhycjhSWnM5MUV1LzR4M3dcblhtOFVHZ0Z1OGxmaVdCdjFXekZSbXRTL3pCcEptQkRuWUljVnJnTy9LOWFFM0cwVWxpOW1FSlBzWFBjbWhzRkxcbkx0eHlROWV3aGdhOWVtSjNpR3lETGo1TWFZTjF2WHZLQk9lQlYwajBHZGdTV3h5bHBTNXh4Zmh3bFEvb01tY09cbnBRbUxGZTJjc1Mra3UxRjUrMmhTSVZESklKOFc4cWVjZ0R2cUxTemJWQjc1OSthcDYzM0x2RVZ3N1Q0OVdVdFlcbm9FcllUS0lNRkJrNHIwZFFGcFFPSDA4OTBNR213T25ieEZtUGtWS2RJSmN5U0JPUEF5WmoyUk5KVzN5RnFSN0VcbnJUZ1k0aGFYenlqVk8vdFliMmpOdTRaRzQyamJHYm5mN3V4eVlJRHRKbERQTHh0SCtxbW5GeTg2ZXpoRWd2OW9cblFMVFFWRUorZ0x0K1I3ZDdwZXlJTWdWenZuWWMybnhVM1VNNzhoVk56blpDcUZ0TzZ6bzVsS1V4MEEvSVdsTDhcbjlnWDcxdHhWTjQvVE1RTWNsZWJkcGlTcktaUm5UK3RtMTYyZGVQMGJ4Tk40OGFjR1RNTjBhY1dsQWdNQkFBR2dcbkx6QXRCZ2txaGtpRzl3MEJDUTR4SURBZU1Cd0dBMVVkRVFRVk1CT0NFWE5sYm5OdmNpMHdNREV1YzJGMmFXOXlcbk1BMEdDU3FHU0liM0RRRUJEUVVBQTRJQ0FRQ2dudjByNW1uT3huRkRTNWk4aUc5M3pQWGlvMldWT2tLVUJweGlcbmJldXZESGozdEVSTkpXbjA5N2pGNytKYVhSd0NCYldIczFwb3RNRzhxU2llTS9rcnFPZkV6T0ZwMFIrNGdWVFpcbnd4b0JFck9qU1lWNVdhRmYwaFZiRnpTY2ZJYmFkd09ZeFZvSktIUXlpN1FxRXpSWjIyTmEvUU55SVpBQU1IM1pcbkE4VEMyWXJDWXYxek45S1J1eXdBb1FBRkJBc1Y4V0FRMzgzUXpKZHAzVHlGMmhPazc2d05vdFN4alQwdEk1ZUtcbnVTaW91VUQ4L1B6K2ZsUGpHT0NUeVJIL3ZmOEdFcXJORjlxV3R1a0dBdkZlMzdWdDVTKy9Cc1ZWdUFYNnptbm5cbmdNaFZLb3NKcVhnTkVQSWNHQ0U1YmVIL2pJMjdWaFQwb0tIWlRnM05tdUU3czNSaFVzY2ZMdjBjL0pjN0hQSU5cbnFWa0JaRVFXbllBOXZ3anRWRUpHL0d0Y3pNVGNJa0NUSExYVmhWY20zU0FHZHAvOXV5d1U5Y3ZCQmRzakdhenZcbjR2VFNZa0tLWUJzNUpTM2YvYVRXWXJnRHVMWktvL3N4TWttSy9zcmZCOHFXbk91by9rVW0xMGdvWW0yOHB0ZTlcblFrVkJOemk3ODBxQmpJOFlKZVBhRjgzWGIrZHQ4MU1ObGk2OTkwL0drL0ZQR0pFNTlLTkZxV2kyMlZmQ2h4Rjhcbmh3M1p6YVp1T3cvam9nWTJJTWM2Q29VTUVVZ2RTcEhJdWZNbmhlOGdKTXorQzBXL1AzS3hzZlFtempqcHlrU2FcbjFpbUNtd3A2cGVxQVlmdlBzZzBOY3FZRmpiZ0RLekE5cmlwNkdRbEg2alJLRm1XcXljejRrS1oycnJHMGZzQ2hcbkNwcVJjQT09XG4tLS0tLUVORCBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS1cbiIsICJwcm9maWxlIjogImRlZmF1bHQiLCAibGFiZWwiOiAiY2xpZW50IGF1dGgiLCAiYnVuZGxlIjogZmFsc2V9


curl -H "Accept: application/json" -H "Content-Type: application/json" -d '{"request": "eyJob3N0bmFtZSI6ICJzZW5zb3ItMDAxLnNhdmlvciIsICJob3N0cyI6IFsic2Vuc29yLTAwMS5zYXZpb3IiXSwgImNlcnRpZmljYXRlX3JlcXVlc3QiOiAiLS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS1cbk1JSUU0RENDQXNnQ0FRQXdiREVMTUFrR0ExVUVCaE1DVlZNeEVUQVBCZ05WQkFnVENGWnBjbWRwYm1saE1SSXdcbkVBWURWUVFIRXdsQmNteHBibWQwYjI0eEdqQVlCZ05WQkFvVEVYTmxibk52Y2kwd01ERXVjMkYyYVc5eU1Sb3dcbkdBWURWUVFERXhGelpXNXpiM0l0TURBeExuTmhkbWx2Y2pDQ0FpSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnSVBcbkFEQ0NBZ29DZ2dJQkFNWVhqVFM3UnYzcDJ6a0VXYlluN0Q4MXdtQysxcjJZRnRJblJNKzhDM1RvSXc0dTdocStcbndWUjBRSUw1UnFEMG8xYW56b2lremVVT2RZeGpUU3BPNnhpbXNBVHZLM1dBMVAvUzR2aHFVbldZZElydWxaSm1cbk52MktGWHd4RWF3VHdibjRDS1c5ekdRVXdEdlZROFhaYWdXaDJBaW9KcThTUXNhQXRVTVpmalFlczg1TlhFTUpcbkh4NkFHU2M0ZzkzNGZTL252eW5lcHVUUjJRbVFyQW42cGZYYlJURjM2MnlyK3pRdHhycjhSWnM5MUV1LzR4M3dcblhtOFVHZ0Z1OGxmaVdCdjFXekZSbXRTL3pCcEptQkRuWUljVnJnTy9LOWFFM0cwVWxpOW1FSlBzWFBjbWhzRkxcbkx0eHlROWV3aGdhOWVtSjNpR3lETGo1TWFZTjF2WHZLQk9lQlYwajBHZGdTV3h5bHBTNXh4Zmh3bFEvb01tY09cbnBRbUxGZTJjc1Mra3UxRjUrMmhTSVZESklKOFc4cWVjZ0R2cUxTemJWQjc1OSthcDYzM0x2RVZ3N1Q0OVdVdFlcbm9FcllUS0lNRkJrNHIwZFFGcFFPSDA4OTBNR213T25ieEZtUGtWS2RJSmN5U0JPUEF5WmoyUk5KVzN5RnFSN0VcbnJUZ1k0aGFYenlqVk8vdFliMmpOdTRaRzQyamJHYm5mN3V4eVlJRHRKbERQTHh0SCtxbW5GeTg2ZXpoRWd2OW9cblFMVFFWRUorZ0x0K1I3ZDdwZXlJTWdWenZuWWMybnhVM1VNNzhoVk56blpDcUZ0TzZ6bzVsS1V4MEEvSVdsTDhcbjlnWDcxdHhWTjQvVE1RTWNsZWJkcGlTcktaUm5UK3RtMTYyZGVQMGJ4Tk40OGFjR1RNTjBhY1dsQWdNQkFBR2dcbkx6QXRCZ2txaGtpRzl3MEJDUTR4SURBZU1Cd0dBMVVkRVFRVk1CT0NFWE5sYm5OdmNpMHdNREV1YzJGMmFXOXlcbk1BMEdDU3FHU0liM0RRRUJEUVVBQTRJQ0FRQ2dudjByNW1uT3huRkRTNWk4aUc5M3pQWGlvMldWT2tLVUJweGlcbmJldXZESGozdEVSTkpXbjA5N2pGNytKYVhSd0NCYldIczFwb3RNRzhxU2llTS9rcnFPZkV6T0ZwMFIrNGdWVFpcbnd4b0JFck9qU1lWNVdhRmYwaFZiRnpTY2ZJYmFkd09ZeFZvSktIUXlpN1FxRXpSWjIyTmEvUU55SVpBQU1IM1pcbkE4VEMyWXJDWXYxek45S1J1eXdBb1FBRkJBc1Y4V0FRMzgzUXpKZHAzVHlGMmhPazc2d05vdFN4alQwdEk1ZUtcbnVTaW91VUQ4L1B6K2ZsUGpHT0NUeVJIL3ZmOEdFcXJORjlxV3R1a0dBdkZlMzdWdDVTKy9Cc1ZWdUFYNnptbm5cbmdNaFZLb3NKcVhnTkVQSWNHQ0U1YmVIL2pJMjdWaFQwb0tIWlRnM05tdUU3czNSaFVzY2ZMdjBjL0pjN0hQSU5cbnFWa0JaRVFXbllBOXZ3anRWRUpHL0d0Y3pNVGNJa0NUSExYVmhWY20zU0FHZHAvOXV5d1U5Y3ZCQmRzakdhenZcbjR2VFNZa0tLWUJzNUpTM2YvYVRXWXJnRHVMWktvL3N4TWttSy9zcmZCOHFXbk91by9rVW0xMGdvWW0yOHB0ZTlcblFrVkJOemk3ODBxQmpJOFlKZVBhRjgzWGIrZHQ4MU1ObGk2OTkwL0drL0ZQR0pFNTlLTkZxV2kyMlZmQ2h4Rjhcbmh3M1p6YVp1T3cvam9nWTJJTWM2Q29VTUVVZ2RTcEhJdWZNbmhlOGdKTXorQzBXL1AzS3hzZlFtempqcHlrU2FcbjFpbUNtd3A2cGVxQVlmdlBzZzBOY3FZRmpiZ0RLekE5cmlwNkdRbEg2alJLRm1XcXljejRrS1oycnJHMGZzQ2hcbkNwcVJjQT09XG4tLS0tLUVORCBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS1cbiIsICJwcm9maWxlIjogImRlZmF1bHQiLCAibGFiZWwiOiAiY2xpZW50IGF1dGgiLCAiYnVuZGxlIjogZmFsc2V9", "token": "dBJlaIkSKqY+IbWFwzeM7pVDTBc6n7If6t9Scr1SBDo="}' http://localhost:3030/api/v1/cfssl/authsign


curl -d '{"label": "primary"}' http://localhost:3030/api/v1/cfssl/info